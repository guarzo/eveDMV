# EVE DMV - Cleanup & Quality Implementation Plan

> **Generated by Claude Code on 2025-01-07**
> 
> This document outlines a comprehensive plan to address code quality, security, and maintainability issues identified in the EVE DMV codebase analysis.

## üö® Critical Issues (Immediate Action Required)

### Week 1: Security & Infrastructure Fixes

#### 1. **Remove Hard-coded Secrets** üîê
- [ ] **Remove `.env` from version control**
  ```bash
  git rm --cached .env
  echo ".env" >> .gitignore
  ```
- [ ] **Regenerate all compromised secrets:**
  - [ ] EVE SSO Client ID/Secret (create new EVE application)
  - [ ] SECRET_KEY_BASE (`mix phx.gen.secret`)
  - [ ] JANICE_API_KEY (regenerate from Janice dashboard)
- [ ] **Implement proper secret management:**
  - [ ] Create `.env.example` template
  - [ ] Add runtime secret validation in `config/runtime.exs`
  - [ ] Document secret setup in README

#### 2. **Fix OTP Process Supervision** ‚ö°
- [ ] **Replace unsupervised spawning in `lib/eve_dmv/enrichment/re_enrichment_worker.ex`:**
  ```elixir
  # Replace lines 138, 151:
  # spawn(fn -> perform_price_update(state.config) end)
  # With:
  Task.Supervisor.start_child(EveDmv.TaskSupervisor, fn -> 
    perform_price_update(state.config) 
  end)
  ```
- [ ] **Add shutdown timeouts to GenServers:**
  - [ ] `PriceCache` - 10 second timeout for ETS cleanup
  - [ ] `MatchingEngine` - 15 second timeout for batch processing
  - [ ] `RealTimePriceUpdater` - 10 second timeout for API cleanup

#### 3. **Security Headers & HTTPS** üõ°Ô∏è
- [ ] **Add security headers in `lib/eve_dmv_web/endpoint.ex`:**
  ```elixir
  plug Plug.Static, headers: %{
    "strict-transport-security" => "max-age=31536000",
    "x-frame-options" => "DENY",
    "x-content-type-options" => "nosniff"
  }
  ```
- [ ] **Enable HTTPS enforcement in production:**
  ```elixir
  # config/prod.exs
  force_ssl: [rewrite_on: [:x_forwarded_proto]]
  ```
- [ ] **Add Content Security Policy configuration**

### Week 2: Dead Code Cleanup & File Organization

#### 4. **Move Test Files to Proper Locations** üßπ
- [ ] **Create test support structure:**
  ```bash
  mkdir -p test/support/killmails
  mkdir -p test/support/intelligence
  ```
- [ ] **Move test utilities:**
  - [ ] `lib/eve_dmv/killmails/pipeline_test.ex` ‚Üí `test/support/killmails/`
  - [ ] `lib/eve_dmv/killmails/test_data_generator.ex` ‚Üí `test/support/killmails/`
- [ ] **Update import paths in existing tests**

#### 5. **Clean Environment Configuration** ‚öôÔ∏è
- [ ] **Remove deprecated settings from `.env.example`:**
  - [ ] `JANICE_API_BASE` (deprecated)
  - [ ] `REDIS_URL` (if Redis not implemented)
  - [ ] Empty `MUTAMARKET_API_KEY` entries
- [ ] **Add validation for required environment variables**

## ‚ö†Ô∏è Sprint 4 Placeholder/Stub Implementation Fixes (Immediate Priority)

### **Critical Discovery**: Sprint 4 Intelligence Modules Are Mostly Placeholders

Analysis reveals that Sprint 4 "intelligence" work consists primarily of stub implementations rather than actual functionality. **~70% of functions return hardcoded or empty data** instead of real analysis.

#### **Replace Placeholder Implementations** üéØ

##### **HomeDefenseAnalyzer Stubs** (`lib/eve_dmv/intelligence/home_defense_analyzer.ex`)
- [ ] **`analyze_rolling_participation/3` (lines 218-239)**: Replace hardcoded rolling stats with real killmail analysis
- [ ] **`get_home_system_battles/3` (lines 390-395)**: Implement actual battle history queries  
- [ ] **`calculate_response_times/1` (lines 397-406)**: Replace hardcoded times with real response analysis
- [ ] **`categorize_threat_types/1` (lines 421-430)**: Implement actual threat categorization from killmail data
- [ ] **`analyze_fleet_doctrines/1` (lines 511-525)**: Replace hardcoded compositions with real fleet analysis
- [ ] **`evaluate_intel_capabilities/1` (lines 537-545)**: Replace hardcoded intel data with real metrics

##### **Deferred HomeDefense Infrastructure Functions** üö´
- ~~`assess_infrastructure_strength/1`~~ - **Removed**: Requires ESI structure/citadel APIs

##### **MemberActivityAnalyzer Stubs** (`lib/eve_dmv/intelligence/member_activity_analyzer.ex`)
- [ ] **`get_character_killmails/3` (lines 359-361)**: Implement actual killmail database queries
- [ ] **`count_*_participation/3` functions (lines 388-391)**: Replace all zero returns with real activity counting
- [ ] **`calculate_participation_rate/3` (line 392)**: Implement real participation rate calculation
- [ ] **`identify_warning_indicators/2` (line 394)**: Build actual warning detection system
- [ ] **`get_corporation_activity_scores/1` (line 395)**: Replace hardcoded scores with real calculations
- [ ] **`analyze_timezone_patterns/2` (lines 295-303)**: Implement real timezone activity analysis

##### **WHVettingAnalyzer Stubs** (`lib/eve_dmv/intelligence/wh_vetting_analyzer.ex`) 
- [ ] **`extract_wh_classes/1` (lines 361-365)**: Implement real WH class extraction from killmail systems
- [ ] **`identify_home_holes/1` (lines 367-371)**: Build actual home hole identification logic
- [ ] **`analyze_rolling_patterns/1` (lines 373-380)**: Replace hardcoded data with real pattern analysis
- [ ] **`analyze_scanning_patterns/1` (lines 382-389)**: Implement actual scanning behavior analysis
- [ ] **`find_eviction_group_connections/2` (lines 391-394)**: Build eviction group correlation system
- [ ] **`analyze_eviction_participation/2` (lines 396-402)**: Implement real eviction analysis
- [ ] **`find_potential_alts/1` (lines 412-414)**: Build alt detection algorithms
- [ ] **`analyze_character_bazaar_signs/1` (lines 416-422)**: Implement character bazaar detection
- [ ] **`identify_security_flags/1` (lines 485-487)**: Build security flag detection system
- [ ] **`identify_behavioral_red_flags/1` (lines 489-491)**: Implement behavioral analysis

##### **Deferred WHVetting Skills Functions** üö´  
- ~~`assess_wh_skills/1`~~ - **Removed**: Requires ESI skills API integration

##### **WHFleetAnalyzer Stubs** (`lib/eve_dmv/intelligence/wh_fleet_analyzer.ex`)
- [ ] **`generate_counter_doctrine_analysis/1` (lines 805-819)**: Build real counter-doctrine logic
- [ ] **`build_counter_template/2` (lines 952-969)**: Implement actual counter-template generation
- [ ] **`estimate_ship_cost/1` (lines 453-460)**: Replace hardcoded costs with market API integration

##### **Deferred/Removed Functionality** üö´
- ~~`get_asset_availability/2`~~ - **Removed**: Requires complex ESI asset integration
- ~~`generate_training_priorities/2`~~ - **Removed**: Requires ESI skills API integration  
- ~~`select_best_ship_for_pilot/2`~~ - **Removed**: Requires pilot skill assessment
- ~~`calculate_pilot_skill_readiness/2`~~ - **Removed**: Requires ESI skills API integration

##### **WHVettingLive UI Stubs** (`lib/eve_dmv_web/live/wh_vetting_live.ex`)
- [ ] **`search_characters/1` (lines 158-166)**: Replace hardcoded results with real ESI character search

#### **ESI Integration Requirements** üîå
- [ ] **Character Employment History**: For vetting and background checks
- [ ] **Character Search API**: For character lookup functionality
- [ ] **Corporation Members API**: For member activity analysis

#### **Deferred ESI Integrations** üö´
- ~~Character Skills API~~ - **Removed**: Complex skill assessment deferred
- ~~Character Assets API~~ - **Removed**: Ship availability analysis deferred  
- ~~Structure/Citadel APIs~~ - **Removed**: Infrastructure assessment deferred

#### **Database Schema Completion** üìä
- [ ] **Populate JSONB fields**: Replace empty `%{}` with actual analysis data
- [ ] **Add missing indexes**: For efficient querying of analysis results
- [ ] **Implement data validation**: Ensure analysis results follow expected schemas

## üî• High Priority Issues (Weeks 3-6)

### Week 3-4: Large File Refactoring

#### 6. **Split Intelligence Analyzers** üìä
**Target: Break 1,000+ line files into 200-300 line focused modules**

- [ ] **Refactor `character_analyzer.ex` (1,533 lines):**
  - [ ] `EveDmv.Intelligence.CharacterAnalyzer` - Core analysis logic (300 lines)
  - [ ] `EveDmv.Intelligence.CharacterMetrics` - Scoring calculations (250 lines)
  - [ ] `EveDmv.Intelligence.CharacterFormatters` - Display helpers (200 lines)
  - [ ] Update all references to use new module structure

- [ ] **Refactor `wh_fleet_analyzer.ex` (1,596 lines):**
  - [ ] `EveDmv.Intelligence.FleetComposition` - Ship composition analysis
  - [ ] `EveDmv.Intelligence.FleetOptimizer` - Pilot assignment optimization
  - [ ] `EveDmv.Intelligence.FleetMetrics` - Performance calculations
  - [ ] `EveDmv.Intelligence.MassCalculator` - Mass efficiency analysis

- [ ] **Refactor `home_defense_analyzer.ex` (1,376 lines):**
  - [ ] `EveDmv.Intelligence.TimezoneAnalyzer` - Coverage analysis
  - [ ] `EveDmv.Intelligence.ResponseAnalyzer` - Response time metrics
  - [ ] `EveDmv.Intelligence.DefenseMetrics` - Scoring and recommendations

- [ ] **Refactor `member_activity_analyzer.ex` (1,335 lines):**
  - [ ] `EveDmv.Intelligence.ActivityAnalyzer` - Core activity logic
  - [ ] `EveDmv.Intelligence.ActivityMetrics` - Score calculations
  - [ ] `EveDmv.Intelligence.ActivityFormatters` - Display formatting

- [ ] **Refactor `wh_vetting_analyzer.ex` (1,222 lines):**
  - [ ] `EveDmv.Intelligence.VettingAnalyzer` - Core vetting logic
  - [ ] `EveDmv.Intelligence.VettingProcessor` - Data processing
  - [ ] `EveDmv.Intelligence.VettingScorer` - Risk assessment

#### 7. **Extract Business Logic from LiveViews** üé≠
- [ ] **Create context modules:**
  - [ ] `EveDmv.Killmails.DisplayService` - Extract from `KillFeedLive`
  - [ ] `EveDmv.Intelligence.CharacterService` - Extract from `CharacterIntelLive`
  - [ ] `EveDmv.Surveillance.ProfileService` - Extract from `SurveillanceLive`

- [ ] **Move formatting logic:**
  - [ ] Create `EveDmv.Presentation.Formatters` module
  - [ ] Move `format_isk/1`, `format_time_ago/1`, etc.
  - [ ] Update all LiveView references

### Week 5-6: Database & Performance Optimization

#### 8. **Complete Ash Framework Implementation** üóÑÔ∏è
- [ ] **Fix bulk operations in static data loader:**
  - [ ] Replace individual `create` calls with `Ash.bulk_create`
  - [ ] Remove "until we get the bulk API right" fallbacks
  - [ ] Test bulk operation performance

- [ ] **Enable Ash relationships:**
  - [ ] Uncomment relationship definitions in resources
  - [ ] Replace manual queries with proper relationship loading
  - [ ] Update intelligence analyzers to use relationships

- [ ] **Add database connection pool configuration:**
  ```elixir
  # config/config.exs
  config :eve_dmv, EveDmv.Repo,
    pool_size: 20,
    queue_target: 50,
    queue_interval: 1000
  ```

#### 9. **Performance Optimization** ‚ö°
- [ ] **Replace Enum chains with Stream in analyzers:**
  - [ ] `character_analyzer.ex:324-372` - Ship usage analysis
  - [ ] `member_activity_analyzer.ex` - Activity calculations
  - [ ] `wh_fleet_analyzer.ex` - Fleet composition processing

- [ ] **Add missing typespecs:**
  - [ ] All public functions in intelligence modules
  - [ ] Complex private functions with business logic
  - [ ] External API client functions

- [ ] **Add guard clauses for validation:**
  - [ ] Numerical score functions
  - [ ] Character ID validation
  - [ ] Date range validations

## üü° Medium Priority Issues (Weeks 7-10)

### Week 7-8: Testing Infrastructure

#### 10. **Fix Test Configuration** üß™
- [ ] **Fix database sandbox configuration:**
  ```elixir
  # config/test.exs
  config :eve_dmv, EveDmv.Repo,
    pool: Ecto.Adapters.SQL.Sandbox
  ```
- [ ] **Add ExCoveralls dependency for coverage reporting**
- [ ] **Create test factories for complex data structures**

#### 11. **Add Critical Business Logic Tests** üìù
- [ ] **Test `character_analyzer.ex`:**
  - [ ] Character analysis workflows
  - [ ] Scoring algorithm edge cases
  - [ ] Error handling scenarios

- [ ] **Test `price_service.ex`:**
  - [ ] Price resolution fallback chains
  - [ ] API failure scenarios
  - [ ] Cache invalidation logic

- [ ] **Test circuit breaker system:**
  - [ ] Failure threshold triggering
  - [ ] Recovery behavior
  - [ ] Telemetry integration

### Week 9-10: Code Quality & Documentation

#### 12. **Standardize Naming Conventions** üìö
- [ ] **Fix abbreviation inconsistencies:**
  - [ ] Standardize `WH` vs `Wh` (choose `WH`)
  - [ ] Align `*Analyzer` vs `*Engine` naming
  - [ ] Clarify `Stats` vs `Intelligence` terminology

- [ ] **Update module documentation:**
  - [ ] Add `@doc` to complex private functions
  - [ ] Include examples in business logic modules
  - [ ] Document algorithm implementations

#### 13. **Error Handling Standardization** ‚ö†Ô∏è
- [ ] **Standardize error patterns:**
  - [ ] Use consistent `{:ok, result} | {:error, reason}` tuples
  - [ ] Remove mixed `case`/`rescue` patterns
  - [ ] Add specific error types

- [ ] **Simplify complex `with` statements:**
  - [ ] Break into separate, testable functions
  - [ ] Add explicit error handling paths
  - [ ] Improve error message clarity

## üü¢ Low Priority Improvements (Weeks 11-12)

### Week 11: Integration & End-to-End Testing

#### 14. **Add Integration Tests** üîó
- [ ] **End-to-end killmail processing** (SSE ‚Üí DB ‚Üí UI)
- [ ] **Character intelligence workflows** (Analysis ‚Üí Caching ‚Üí Display)
- [ ] **Surveillance alert pipelines** (Profile matching ‚Üí Notifications)
- [ ] **Price resolution fallback chains** (API failures ‚Üí Fallback strategies)

#### 15. **Performance & Load Testing** üìà
- [ ] **Killmail pipeline throughput testing**
- [ ] **Database query performance validation**
- [ ] **API rate limiting effectiveness**
- [ ] **Concurrent user LiveView performance**

### Week 12: Documentation & Monitoring

#### 16. **Enhanced Monitoring** üìä
- [ ] **Add process supervision health checks**
- [ ] **Implement Broadway pipeline monitoring**
- [ ] **Add database query performance telemetry**
- [ ] **Enhanced security audit logging**

#### 17. **Documentation Updates** üìñ
- [ ] **Update README with new module structure**
- [ ] **Add security setup documentation**
- [ ] **Create deployment security checklist**
- [ ] **Document testing strategy and coverage goals**

## üìä Progress Tracking

### Completion Metrics
- [ ] **Critical Issues**: 0/17 completed
- [ ] **High Priority**: 0/45 completed  
- [ ] **Medium Priority**: 0/28 completed
- [ ] **Low Priority**: 0/15 completed

### Success Criteria
- [ ] **Security Score**: C ‚Üí A (no hard-coded secrets, proper headers)
- [ ] **File Size**: 5 files under 500 lines (from 1,000+ lines)
- [ ] **Test Coverage**: 15% ‚Üí 70% for critical business logic
- [ ] **Code Quality**: B- ‚Üí A- (Credo passing, proper patterns)

## üõ†Ô∏è Tools & Commands

### Quality Assurance Commands
```bash
# Run all quality checks
./scripts/quality_check.sh

# Individual checks
mix format --check-formatted
mix credo --strict
mix test --warnings-as-errors
mix deps.audit
```

### Large File Identification
```bash
# Find files over 300 lines
find lib -name "*.ex" -exec wc -l {} + | sort -nr | head -20

# Check specific file size
wc -l lib/eve_dmv/intelligence/character_analyzer.ex
```

### Security Validation
```bash
# Check for hard-coded secrets
grep -r "SECRET\|KEY\|TOKEN" config/
grep -r "password\|secret" .env*

# Validate environment variables
mix run -e "IO.inspect(System.get_env())"
```

---

## üìû Implementation Support

**Questions or Issues?**
- Create GitHub issues for specific implementation challenges
- Reference this document in pull requests
- Update completion status as work progresses

### üìä Progress Tracking

#### Completion Metrics
- [ ] **Critical Issues**: 0/17 completed
- [ ] **Sprint 4 Stubs**: 0/24 completed ‚ö†Ô∏è **NEW CRITICAL PRIORITY**
- [ ] **High Priority**: 0/45 completed  
- [ ] **Medium Priority**: 0/28 completed
- [ ] **Low Priority**: 0/15 completed

#### Success Criteria
- [ ] **Security Score**: C ‚Üí A (no hard-coded secrets, proper headers)
- [ ] **File Size**: 5 files under 500 lines (from 1,000+ lines)
- [ ] **Test Coverage**: 15% ‚Üí 70% for critical business logic
- [ ] **Code Quality**: B- ‚Üí A- (Credo passing, proper patterns)
- [ ] **Functionality**: Replace 24 core stub implementations with real logic ‚ö†Ô∏è **NEW**

**Estimated Timeline**: 16 weeks (4 months) - **Extended due to stub discovery**
**Effort Level**: Very High (significant functionality must be built from scratch)
**Risk Level**: High (most intelligence features are non-functional stubs)

---

## ‚ö†Ô∏è **CRITICAL DISCOVERY IMPACT**

The analysis reveals that **Sprint 4 delivered primarily placeholder code rather than working functionality**. This significantly impacts:

1. **Timeline**: Extended from 12 to 16 weeks due to actual implementation needed
2. **Effort**: Increased from "High" to "Very High" - building functionality vs. refactoring
3. **Risk**: Elevated to "High" - most intelligence features need to be built from scratch
4. **Priority**: Stub replacement becomes **critical priority** alongside security fixes

**Recommendation**: Consider whether to continue with stub replacement or redesign the intelligence system architecture before implementing individual features.

---

*This implementation plan addresses 125+ specific action items including 24 core stub implementations that require complete rewriting. The Sprint 4 intelligence modules are largely non-functional and need substantial development work to provide real value.*